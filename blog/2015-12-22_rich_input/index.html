<!--
Copyright (C) 2015 David Stein

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
SOFTWARE.


-->
<html>

<head>
    <title>stein - Rich text editing on the web</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta content="Rich text editing on the web" property="og:title" />
    <meta content="Rich text editing on the web" property="twitter:title" />
    <meta content="A brief intro to rich text editing on the web" name="twitter:description" />
    <meta content="A brief intro to rich text editing on the web" name="og:description" />
    <meta content="/static/img/favicon.ico" name="twitter:image" />
    <meta content="/static/img/favicon.ico" name="og:image" />
    <link rel="icon" href="/static/img/favicon.ico" type="image/x-icon" />
    <link rel="stylesheet" type="text/css" href="/static/css/main.css">
    <link rel="stylesheet" type="text/css" href="/external/commonmark-react/cm-react.css">
    <script data-main="/compiled-coffee/app.js" src="/external/require.js"></script>
<script id="content" type="text/markdown">%22%5Cn%23%20Making%20rich%20text%20input%20for%20the%20web.%5Cn%5Cn__tl%3Bdr%3A__%20Here%27s%20an%20%5Bexample%5D%28example7.html%29.%20Here%27s%20the%20%5Bsource%5D%28/static/source_viewer_dyn.html%23/blog/2015-12-22_rich_input/example7.html%29.%5Cn%5CnI%20recently%20set%20out%20to%20build%20a%20rich%20input%20box%2C%20assuming%20some%20googling%20and%20stack%20overflow%20articles%20would%20be%20enough%20to%20get%20started.%20I%20found%20a%20lot%20of%20content%20on%20how%20bad%20the%20tools%20the%20browser%20gives%20you%20are.%20I%20found%20less%20help%20on%20how%20to%20get%20started%20building%20something.%20This%20is%20an%20attempt%20to%20document%20my%20initial%20learnings%20from%20building%20simple%20rich%20text%20editing%20on%20the%20web.%5Cn%5CnThere%20are%20two%20big%20parts%20of%20building%20a%20rich%20editing%20experience.%20The%20first%20is%20detecting%20the%20content%20a%20user%20inputs%2C%20the%20second%20is%20displaying%20that%20content.%20I%20knew%20enough%20CSS%20and%20HTML%20to%20get%20content%20on%20a%20page%3B%20this%20post%20focuses%20mostly%20on%20capturing%20input%20cleanly.%5Cn%5CnA%20kind-of-standard%20for%20managing%20user%20input%20is%20the%20%60contenteditable%60%20attribute%2C%20which%20as%20far%20as%20I%20can%20tell%20is%20an%20artifact%20of%20an%20Internet%20Explorer%205.5%20feature%20for%20editing%20emails%20in%20Outlook%20Online.%20The%20feature%20was%20%5Bsort-of-cloned%5D%28https%3A//bugzilla.mozilla.org/show_bug.cgi%3Fid%3D97284%29%20by%20other%20browsers.%20It%27s%20%5Bbug%20ridden%5D%28https%3A//codemirror.net/doc/internals.html%29%20at%20best%20and%20%5Bbroken%20by%20design%5D%28https%3A//medium.com/medium-eng/why-contenteditable-is-terrible-122d8a40e480%29%20at%20worst.%20It%27s%20also%20very%20powerful%20if%20you%20can%20avoid%20the%20messy%20parts.%5Cn%5CnThere%20many%20great%20%5Bopen%5D%28https%3A//github.com/ajaxorg/ace%29%20%5Bsource%5D%28https%3A//codemirror.net/%29%20%5Bprojects%5D%28https%3A//github.com/dropbox/hackpad%29%20that%20have%20a%20robust%20approach%20to%20fully-featured%20rich%20text%20editing.%20I%20was%20more%20interested%20in%20building%20some%20basic%20functionality%20%28autocomplete%20and%20at-mentioning%29%20without%20loading%20an%20entire%20text%20editor%20before%20page%20load.%5Cn%5Cn---%5Cn%5Cn%23%23%20Getting%20to%20know%20%60contenteditable%60%5Cn%5CnIt%27s%20worth%20playing%20with%20%60contenteditable%60%20a%20little.%20%5Cn%5CnI%27ve%20iframe%27d%20in%20an%20div%20with%20the%20contenteditable%20flag%20set%2C%20I%27d%20recommend%20using%20the%20link%20beneath%20it%20to%20try%20it%20in%20a%20new%20tab.%20Here%20are%20some%20things%20to%20try%3A%5Cn%5Cn%20-%20type%20into%20the%20box.%5Cn%20-%20copy%20and%20paste%20part%20of%20a%20website.%20Images%2C%20formatting%2C%20potentially%20some%20javascript%20%28%60onclick%3D%60%2C%20for%20example%29%5Cn%20-%20copy%20something%20with%20complex%20CSS%20%28ie%2C%20explicit%20positioning%29.%20Stuff%20can%20escape%20the%20box.%5Cn%5Cn%60%60%60%5Cn%3Chtml%3E%5Cn%20%20%3Cbody%3E%5Cn%20%20%20%20%3Cdiv%20contenteditable%3D%5C%22true%5C%22%3E%5Cn%20%20%20%20%20%20editable%20content%21%5Cn%20%20%20%20%3C/div%3E%5Cn%20%20%3C/body%3E%5Cn%3C/html%3E%5Cn%60%60%60%5Cn%5Cn%3Ciframe%20src%3D%5C%22example1.html%5C%22%20sandbox%3E%5Cn%20%20%20this%20must%20be%20multiple%20lines%5Cn%3C/iframe%3E%5Cn%3Cdiv%20style%3D%5C%22float%3Aright%5C%22%3E%5Cn%3Ca%20href%3D%5C%22example1.html%5C%22%20target%3D%5C%22_blank%5C%22%3Eexample1.html%3C/a%3E%5Cn%28%20%3Ca%20href%3D%5C%22/static/source_viewer_dyn.html%23/blog/2015-12-22_rich_input/example1.html%5C%22%20target%3D%5C%22_blank%5C%22%3Efull%20source%3C/a%3E%20%29%5Cn%3C/div%3E%5Cn%3Cdiv%20style%3D%5C%22clear%3Aboth%5C%22%3E%3C/div%3E%5Cn%5Cn%5Cn%23%23%20Setting%20up%20a%20text%20input%5Cn%5CnMy%20first%20goal%20is%20to%20build%20something%20that%20behaves%20like%20a%20%60textarea%60.%20Pretty%20much%20any%20box%20that%20allows%20only%20text%20input%20and%20has%20a%20cursor%20location%20will%20work.%20I%27m%20going%20to%20use%20a%20%60div%60%20with%20the%20%60contenteditable%60%20flag%20set%20to%20manage%20the%20cursor%2C%20and%20then%20restrict%20behavior%20to%20only%20allow%20plain%20text.%5Cn%5Cn%23%23%23%20Restricting%20input%20to%20plain%20text%5Cn%5CnStarting%20with%20the%20box%20in%20the%20first%20example%2C%20I%20now%20want%20to%20restrict%20the%20contents%20of%20the%20box%20to%20_only%20be%20text_.%20On%20some%20webkit%20browsers%20the%20attr%20%60contenteditable%3D%5C%22plaintext-only%5C%22%60%20does%20this%3B%20not%20all%20browsers%20are%20webkit.%5Cn%5CnMy%20approach%20is%20to%20capture%20any%20insertion%20that%20_isn%27t%20a%20single%20character%20resulting%20from%20a%20keystroke_%20and%20define%20some%20custom%20behavior.%20This%20means%20I%20need%20to%20detect%20__drag/drop__%20and%20__paste__%20events.%20According%20to%20the%20docs%20these%20insertions%20always%20trigger%20%5Ba%20drop%20event%5D%28http%3A//www.w3.org/TR/2008/WD-html5-20080610/editing.html%23paste%29.%20In%20practice%2C%20I%20need%20to%20listen%20for%20%60paste%60%20events%20as%20well.%5Cn%5Cn%5Cn%60%60%60%5Cnfunction%20paste_event_handler%28e%29%7B%5Cn%20%20var%20raw_text%2C%20raw_data%2C%20paste_data%3B%5Cn%5Cn%20%20//%20prevent%20the%20paste%20from%20happening%5Cn%20%20e.preventDefault%28%29%3B%5Cn%5Cn%20%20//%20try%20to%20get%20the%20data%20from%20a%20DragEvent%5Cn%20%20raw_data%20%3D%20e.dataTransfer%3B%5Cn%5Cn%20%20//%20fall%20back%20to%20data%20from%20a%20ClipboardEvent%5Cn%20%20paste_data%20%3D%20e.clipboardData%3B%5Cn%20%20raw_data%20%3D%20raw_data%20%7C%7C%20paste_data%3B%5Cn%5Cn%20%20//%20extract%20the%20raw%20text%20from%20the%20pasted%20data%5Cn%20%20raw_text%20%3D%20raw_data.getData%28%5C%22Text%5C%22%29%3B%5Cn%20%20console.log%28raw_text%29%3B%5Cn%7D%3B%5Cn%5Cn//%20set%20up%20listeners%20for%20%60drop%60%20and%20%60paste%60%20events%5Cnvar%20editable_div%20%3D%20document.getElementById%28%5C%22my-editable-div%5C%22%29%3B%5Cneditable_div.addEventListener%28%5C%22drop%5C%22%2C%20paste_event_handler%29%3B%5Cneditable_div.addEventListener%28%5C%22paste%5C%22%2C%20paste_event_handler%29%3B%5Cn%60%60%60%5Cn%5Cn%3Ciframe%20src%3D%5C%22example2.html%5C%22%20sandbox%3D%5C%22allow-scripts%5C%22%3E%5Cn%3C/iframe%3E%5Cn%3Cdiv%20style%3D%5C%22float%3Aright%5C%22%3E%5Cn%3Ca%20href%3D%5C%22example2.html%5C%22%20target%3D%5C%22_blank%5C%22%3Eexample2.html%3C/a%3E%5Cn%28%20%3Ca%20href%3D%5C%22/static/source_viewer_dyn.html%23/blog/2015-12-22_rich_input/example2.html%5C%22%20target%3D%5C%22_blank%5C%22%3Efull%20source%3C/a%3E%20%29%5Cn%3C/div%3E%5Cn%3Cdiv%20style%3D%5C%22clear%3Aboth%5C%22%3E%3C/div%3E%5Cn%5Cn%3E%20Here%27s%20an%20experiment%20that%20suppresses%20any%20input%20that%20isn%27t%20normal%20typing%2C%20instead%20logging%20the%20content%20to%20the%20console.%20No%20need%20to%20open%20a%20dev%20console%2C%20output%20is%20captured%20and%20displayed%20on%20the%20page.%20On%20most%20browsers%2C%20drag-drop%20from%20outside%20an%20iFrame%20is%20suppressed.%5Cn%5Cn%23%23%23%20Finding%20the%20cursor%5Cn%5CnAccording%20to%20the%20%5Bw3c%20working%20draft%5D%28http%3A//www.w3.org/TR/2008/WD-html5-20080610/editing.html%29%2C%20when%20an%20editable%20element%20has%20focus%20it%20has%20a%20cursor%20or%20selection.%20You%20can%20check%20on%20the%20cursor%20or%20selection%27s%20position%20programmatically.%5Cn%5CnBefore%20inserting%20content%20at%20the%20cursor%2C%20I%20needed%20to%20understand%20the%20structure%20of%20selection%20ranges%20and%20how%20to%20manipulate%20them.%20I%27ll%20review%20the%20basics%2C%20but%20you%20can%20%5Bskip%20ahead%5D%28%23section-2.3%29.%5Cn%5Cn%23%23%23%23%20Nodes%2C%20Selections%2C%20and%20Ranges%5Cn%5CnThe%20content%20of%20a%20div%20is%20composed%20of%20a%20set%20of%20%5BNodes%5D%28http%3A//www.w3.org/2003/01/dom2-javadoc/org/w3c/dom/Node.html%29%20%28as%20is%20the%20rest%20of%20the%20DOM%29.%20For%20my%20purposes%20there%20are%20two%20types%20of%20nodes%3A%5Cn%5Cn%20-%20__text%20nodes__%20-%20blocks%20of%20text.%20don%27t%20have%20any%20additional%20markup%5Cn%20-%20__elements__%20-%20the%20DOM%20nodes%20we%20manipulate%20all%20the%20time%20%28divs%2C%20spans%2C%20etc%29%5Cn%5CnIf%20there%20is%20focus%20on%20the%20page%2C%20it%20is%20represented%20as%20a%20%60Range%60.%20A%20range%20has%20a%20start%20location%20and%20an%20end%20location%2C%20called%20%5Bboundary%20points%5D%28http%3A//www.w3.org/TR/DOM-Level-2-Traversal-Range/ranges.html%23Level-2-Range-Position%29%29.%20A%20boundary%20point%20is%20defined%20by%20a%20node%20and%20an%20offset.%5Cn%5CnIn%20a%20text%20node%20a%20_boundary%20point_%20is%20effectively%20an%20index%20into%20a%20string%3A%20the%20boundary%20point%20is%20immediately%20after%20the%20%3C%60offset%60%3Eth%20character%20in%20the%20string%20%28or%20before%20the%20first%20char%20if%20offset%20%3D%200%29.%5Cn%5CnIn%20an%20elements%2C%20the%20boundary%20point%20lies%20between%20nodes%20immediately%20after%20the%20%3C%60offset%60%3Eth%20child%20node.%5Cn%5CnI%20found%20this%20easier%20to%20understand%20after%20playing%20with%20it%2C%20I%27ve%20written%20a%20tool%20for%20playing%20with%20boundary%20points.%20Different%20browsers%20will%20behave%20slightly%20differently%20along%20the%20boundaries%20between%20nodes%2C%20but%20the%20way%20in%20which%20indexing%20works%20should%20stay%20the%20same.%5Cn%5CnIn%20this%20demo%2C%20there%20is%20a%20graphical%20representation%20of%20the%20nodes%2C%20with%20red%20and%20green%20dots%20at%20the%20boundary%20points%20when%20the%20box%20has%20focus.%5Cn%5Cn%60%60%60%5Cn%3C%21--%20raw%20html%20from%20example%20--%3E%5Cn%20%20try%5Cn%20%20%3Cspan%20style%3D%5C%22color%3A%20red%5C%22%3E%5Cn%20%20%20%20%3Cb%3E%20highlight%3C/b%3E%5Cn%20%20%20%20ing%20or%20clicking%20parts%20of%5Cn%20%20%3C/span%3E%5Cn%20%20this%20sentence%5Cn%60%60%60%5Cn%5Cn%3Ciframe%20src%3D%5C%22example3.html%5C%22%20style%3D%5C%22height%3A320px%5C%22%20sandbox%3D%5C%22allow-scripts%5C%22%3E%5Cn%3C/iframe%3E%5Cn%3Ca%20href%3D%5C%22example3.html%5C%22%20target%3D%5C%22_blank%5C%22%20style%3D%5C%22float%3Aright%5C%22%3Eexample3.html%3C/a%3E%5Cn%3Cdiv%20style%3D%5C%22clear%3Aboth%5C%22%3E%3C/div%3E%5Cn%5CnNotice%20that%20%5C%22this%5C%22%20and%20%5C%22sentence%5C%22%20are%20different%20nodes%20even%20though%20they%20are%20the%20same%20chunk%20of%20HTML.%20Try%20typing%2C%20and%20using%20ctrl%2Bi%20and%20ctrl%2Bb%20to%20bold%20and%20italify%20text.%20Depending%20on%20your%20browser%2C%20you%20may%20be%20able%20to%20position%20boundary%20points%20_between_%20the%20text%20nodes%20or%20element%20boundaries.%20Each%20browser%20is%20a%20little%20different%20in%20their%20implementation%20of%20this%20behavior.%5Cn%5Cn%3E%20The%20%60normalize%60%20function%20tries%20to%20join%20text_nodes%20when%20they%20appear%20next%20to%20each%20other.%20You%20can%20call%20it%20on%20a%20parent%20node%20that%20contains%20multiple%20child%20nodes.%5Cn%5Cn%23%23%23%23%20List%20of%20useful%20commands%20for%20manipulating%20selection%20ranges%5Cn%5CnI%20need%20to%20manipulate%20selection%20ranges%20as%20I%20mutate%20the%20div%20to%20make%20the%20text%20%5C%22rich%5C%22.%20The%20selection%20and%20range%20APIs%20can%20do%20a%20lot%20of%20things%20-%20these%20are%20the%20fields%20and%20functions%20I%20use%20over%20the%20rest%20of%20this%20post%20to%20work%20with%20selections.%5Cn%5Cn-%20%60document.getSelection%28%29%60%5Cn%5Cn%20%20Returns%20a%20%60Selection%60%2C%20which%20represents%20the%20current%20selection%20in%20the%20document%3B%20contains%20zero%20or%20more%20%60Range%60%27s%5Cn%5Cn-%20%60Selection.rangeCount%60%5Cn%5Cn%20%20the%20number%20of%20%60Range%60%27s%20in%20the%20selection.%20This%20is%20either%200%20or%201%20in%20almost%20every%20practical%20situation.%5Cn%5Cn%20%20_There%20are%20some%20rare%20cases%20when%20%60rangeCount%20%3E%201%60.%20The%20most%20common%20is%20when%20the%20user%20selects%20some%20text%20with%20one%20input%20device%20%28ie%2C%20a%20mouse%29%20and%20then%20moves%20focus%20with%20another%20device%20%28ie%2C%20hitting%20tab%20on%20a%20keyboard%29%20-%20resulting%20in%20two%20selection%20ranges.%20For%20this%20post%2C%20I%27ll%20assume%20that%20there%20is%20at%20most%20one%20range.%20In%20practice%20you%20will%20have%20to%20handle%20higher%20%60rangeCount%60s%20by%20checking%20which%20elements%20have%20focus._%5Cn%5Cn-%20%60Range.startContainer%60%2C%20%60Range.startOffset%60%2C%20%60Range.endContainer%60%2C%20%60Range.endOffset%60%5Cn%5Cn%20%20The%20%28node%2C%20offset%29%20pairs%20defining%20a%20range.%5Cn%5Cn-%20%60Range.deleteContents%28%29%60%5Cn%5Cn%20%20Delete%20the%20content%20between%20the%20boundaries%2C%20removing%20any%20nodes%20that%20are%20contained%20completely%20between%20those%20two%20points.%5Cn%5Cn-%20%60Range.insertNode%28node%29%60%5Cn%5Cn%20%20Inserts%20a%20node%20immediately%20after%20the%20start%20boundary%2C%20splitting%20any%20text%20nodes%20into%20multiple%20nodes%20and%20pushing%20any%20other%20boundary%20points%20to%20the%20end%20of%20the%20inserted%20node.%5Cn%5Cn%20%20_before%20insert_%20-%20%60%3Cstart1%3E%3Cstart2%3E%3Cend1%3E%60%20__content__%20%60%3Cend2%3E%60%5Cn%5Cn%20%20_after%20insert_%20-%20%60%3Cstart1%3E%60%20%3CINSERTED_NODE%3E%20%60%3Cstart2%3E%3Cend1%3E%60%20__content__%20%60%3Cend2%3E%60%5Cn%5Cn-%20%60Range.setStart%28node%2C%20offset%29%60%2C%20%60Range.setEnd%28node%2C%20offset%29%60%5Cn%5Cn%20%20Adjust%20the%20boundaries.%5Cn%5Cn-%20%60Node.normalize%28%29%60%5Cn%5Cn%20%20Combine%20adjacent%20child%20text%20nodes%20into%20a%20single%20node.%5Cn%5Cn%23%23%23%20Handling%20pasted%20content%5Cn%5CnUsing%20this%20API%2C%20I%20add%20functionality%20for%20pasting%20and%20dropping%20content%20back%20into%20the%20input%20box.%20I%20_only%20insert%20the%20text_%2C%20ignoring%20styling%20and%20formatting.%5Cn%5Cn%60%60%60%5Cnfunction%20get_range%28%29%7B%5Cn%20%20var%20sel%20%3D%20document.getSelection%28%29%3B%5Cn%20%20//%20rangeCount%20is%200%20if%20nothing%20is%20selected%20%28ie%2C%20we%20do%5Cn%20%20//%20not%20have%20user%20focus%29%5Cn%20%20if%20%28sel.rangeCount%20%3D%3D%3D%200%29%20%7B%5Cn%20%20%20%20return%3B%5Cn%20%20%7D%5Cn%20%20//%20if%20the%20browser%20allows%20multiple%20simultaneous%20selections%2C%5Cn%20%20//%20much%20of%20this%20example%20needs%20to%20be%20fancier.%20Luckily%20most%5Cn%20%20//%20browsers%20don%27t%20allow%20that%20while%20editing%20text.%5Cn%20%20return%20sel.getRangeAt%280%29%3B%5Cn%7D%5Cn%5Cnfunction%20insert_text_at_cursor%28text%29%7B%5Cn%20%20//%20get%20user%20selection%2C%20if%20there%20is%20any%5Cn%20%20var%20range%20%3D%20get_range%28%29%3B%5Cn%20%20if%20%28%21range%29%20return%3B%5Cn%5Cn%20%20//%20delete%20the%20selection%20if%20needed%5Cn%20%20range.deleteContents%28%29%3B%5Cn%5Cn%20%20//%20insert%20text%5Cn%20%20var%20text_node%20%3D%20document.createTextNode%28text%29%3B%5Cn%20%20range.insertNode%28text_node%29%3B%5Cn%5Cn%20%20//%20the%20%5C%22start%5C%22%20of%20our%20range%20is%20now%20before%20the%20inserted%20text%2C%5Cn%20%20//%20we%20need%20to%20move%20it%20to%20the%20end...%5Cn%20%20range.setStart%28range.endContainer%2C%20range.endOffset%29%3B%5Cn%5Cn%20%20//%20...and%20then%20force%20user%20focus%20to%20that%20range%5Cn%20%20document.getSelection%28%29.removeAllRanges%28%29%5Cn%20%20document.getSelection%28%29.addRange%28range%29%5Cn%7D%5Cn%5Cn%60%60%60%5Cn%5Cn%3Ciframe%20src%3D%5C%22example4.html%5C%22%20style%3D%5C%22height%3A54px%5C%22%20sandbox%3D%5C%22allow-scripts%5C%22%3E%5Cn%3C/iframe%3E%5Cn%3Cdiv%20style%3D%5C%22float%3Aright%5C%22%3E%5Cn%3Ca%20href%3D%5C%22example4.html%5C%22%20target%3D%5C%22_blank%5C%22%3Eexample4.html%3C/a%3E%5Cn%28%20%3Ca%20href%3D%5C%22/static/source_viewer_dyn.html%23/blog/2015-12-22_rich_input/example4.html%5C%22%20target%3D%5C%22_blank%5C%22%3Efull%20source%3C/a%3E%20%29%5Cn%3C/div%3E%5Cn%3Cdiv%20style%3D%5C%22clear%3Aboth%5C%22%3E%3C/div%3E%5Cn%5CnSome%20things%20are%20not%20suppressed%20here%3A%20a%20user%20can%20still%20add%20emphasis%20to%20text%20on%20most%20user%20agents%20%28ctrl%2Bb%20on%20desktop%2C%20for%20example%29.%20Rather%20than%20catching%20those%20cases%2C%20I%20am%20going%20to%20add%20some%20heavy-handed%20formatting%20logic%20that%20overwrites%20any%20of%20the%20formatting%20behavior%20provided%20by%20the%20user%20agent.%5Cn%5Cn%3Ca%20name%3D%5C%22cursor%5C%22%3E%3C/a%3E%5Cn%5Cn%23%23%20Putting%20it%20together%3A%20building%20a%20rich%20text%20input%20area%5Cn%5CnNow%20that%20I%20have%20a%20%5C%22%60textarea%60%5C%22%20%20that%20mostly%20works%2C%20I%27m%20ready%20to%20add%20some%20intelligence.%20For%20my%20demo%20I%27d%20like%20to%20__turn%20%40-mentions%20blue__.%5Cn%5CnAs%20a%20starting%20point%2C%20I%20just%20reformat%20the%20text%20after%20each%20keystroke.%20This%20doesn%27t%20preserve%20cursor%20position.%20The%20textarea%20is%20almost%20unusable%20with%20the%20cursor%20jumping%20all%20over%20the%20place.%5Cn%5Cn%23%23%23%23%20Simple%20replacement%20code%5Cn%5Cn%60%60%60%5Cnvar%20AT_MENTION_REGEX%20%3D%20/%28%28%3F%21%5C%5Cw%29%40%5B%5C%5Cw%5D%2B%29/g%3B%5Cn%5Cn/%2A%5Cn%2A%20Highlight%20%40-mentions%20in%20the%20most%20na%5Cu00efve%20way%5Cn%2A%20possible%20-%20rebuild%20the%20entire%20div%2C%20clear%5Cn%2A%20and%20replace.%20Highly%20recommend%20you%20do%20something%5Cn%2A%20more%20efficient%20in%20practice%20%3A-%29%5Cn%2A/%5Cnfunction%20format_content%28%29%7B%5Cn%20%20//%20editable_div%20is%20the%20editable%20DOM%20element%5Cn%20%20//%20%28see%20example%202%20and%20onwards%29%5Cn%20%20var%20raw_content%20%3D%20editable_div.textContent%3B%5Cn%20%20editable_div.innerHTML%20%3D%20raw_content.replace%28%5Cn%20%20%20%20AT_MENTION_REGEX%2C%5Cn%20%20%20%20%5C%22%3Cspan%20style%3D%27color%3Acyan%27%3E%241%3C/span%3E%5C%22%5Cn%20%20%29%3B%5Cn%7D%5Cn%5Cneditable_div.addEventListener%28%5C%22keyup%5C%22%2C%20format_content%29%3B%5Cn%60%60%60%5Cn%5Cn%3Ciframe%20src%3D%5C%22example5.html%5C%22%20style%3D%5C%22height%3A54px%5C%22%20sandbox%3D%5C%22allow-scripts%5C%22%3E%5Cn%3C/iframe%3E%5Cn%3Cdiv%20style%3D%5C%22float%3Aright%5C%22%3E%5Cn%3Ca%20href%3D%5C%22example5.html%5C%22%20target%3D%5C%22_blank%5C%22%3Eexample5.html%3C/a%3E%5Cn%28%20%3Ca%20href%3D%5C%22/static/source_viewer_dyn.html%23/blog/2015-12-22_rich_input/example5.html%5C%22%20target%3D%5C%22_blank%5C%22%3Efull%20source%3C/a%3E%20%29%5Cn%3C/div%3E%5Cn%3Cdiv%20style%3D%5C%22clear%3Aboth%5C%22%3E%3C/div%3E%5Cn%5Cn%23%23%23%20Preserving%20cursor%20position%5Cn%5CnOne%20way%20to%20avoid%20moving%20focus%20when%20mutating%20an%20editable%20region%20is%20to%20mark%20the%20cursor%20position.%20As%20three%20as%20the%20text%20is%20preserved%2C%20the%20markers%20should%20be%20as%20well.%20I%20do%20this%20in%20three%20steps%5Cn%5Cn%201.%20mark%20the%20beginning%20and%20end%20of%20the%20selection%20ranges%20using%20unique%20characters%5Cn%201.%20mutate%20the%20contents%5Cn%201.%20restore%20the%20selection%20and%20remove%20the%20markers%5Cn%5CnThis%20breaks%20if%20the%20delimiter%20characters%20appear%20elsewhere%20in%20the%20content%20being%20edited.%20I%20work%20around%20this%20problem%20using%20%5Bprivate%20use%20unicode%20characters%5D%28https%3A//en.wikipedia.org/wiki/Private_Use_Areas%29.%20I%20enforce%20that%20two%20reserved%20characters%20are%20never%20used%20in%20the%20textarea%2C%20that%20way%20I%20can%20use%20them%20as%20markers.%5Cn%5Cn%23%23%23%23%23%20Add%20calls%20to%20mark%20and%20restore%20the%20cursor%5Cn%5CnI%20start%20by%20adding%20%60mark_cursor%60%20and%20%60restore_cursor%60%20functions%20to%20the%20code%20from%20above.%5Cn%5Cn%60%60%60%5Cn//%20set%20the%20markers%5Cnvar%20START_RANGE_MARKER%20%3D%20%5C%22%5C%5Cu0091%5C%22%5Cnvar%20END_RANGE_MARKER%20%3D%20%5C%22%5C%5Cu0092%5C%22%5Cn%5Cn//%20messy%20regex%20hack%20to%20stop%20the%20cursor%20from%20interfering%5Cn//%20with%20matching%20mentions%20-%20in%20practice%20we%20should%20remove%5Cn//%20the%20cursor%20markers%20before%20doing%20tokenization%20logic.%5Cnvar%20AT_MENTION_REGEX%20%3D%20/%28%28%3F%21%5C%5Cw%29%40%5B%5C%5Cw%5C%5Cu0091%5C%5Cu0092%5D%2B%29/g%5Cn%5Cn/%2A%5Cn%2A%20Highlight%20%40-mentions%20in%20the%20most%20na%5Cu00efve%20way%20possible%20-%20rebuild%5Cn%2A%20the%20entire%20div%2C%20clear%20and%20replace.%20Highly%20recommend%20you%5Cn%2A%20do%20something%20more%20efficient%20%3A-%29%5Cn%2A/%5Cnfunction%20format_content%28%29%7B%5Cn%20%20var%20raw_content%3B%5Cn%20%20mark_cursor%28%29%3B%20//%20implemented%20below%5Cn%20%20raw_content%20%3D%20editable_div.textContent%3B%5Cn%20%20editable_div.innerHTML%20%3D%20raw_content.replace%28%5Cn%20%20%20%20AT_MENTION_REGEX%2C%5Cn%20%20%20%20%5C%22%3Cspan%20style%3D%27color%3Acyan%27%3E%241%3C/span%3E%5C%22%5Cn%20%20%29%3B%5Cn%20%20restore_cursor%28%29%3B%20//%20implemented%20below%5Cn%7D%5Cn%60%60%60%5Cn%5Cn%23%23%23%23%23%20Cursor%20marking%20function%5Cn%5CnI%20get%20the%20Selection%20and%20Range%2C%20and%20mark%20them%20with%20my%20reserved%20characters.%20Since%20the%20function%20above%20doesn%27t%20remove%20characters%2C%20these%20will%20remain%20even%20after%20we%20format%20the%20text.%5Cn%5CnFor%20this%20example%20I%20use%20a%20helper%20function%20to%20insert%20the%20markers%2C%20in%20practice%20I%20use%20the%20same%20helper%20function%20to%20handle%20pasted%20text.%5Cn%5Cn%60%60%60%5Cn/%2A%5Cn%2A%20marks%20the%20current%20location%20of%20the%20cursor%20or%20selection%5Cn%2A/%5Cnfunction%20mark_cursor%28%29%7B%5Cn%20%20var%20range%20%3D%20get_range%28%29%3B%5Cn%20%20//%20The%20order%20matters%20here%21%5Cn%20%20//%20See%20the%20notes%20on%20how%20Node.insertCursor%28%29%20works%5Cn%20%20//%20above.%5Cn%20%20_insert_char%28END_RANGE_MARKER%2C%5Cn%20%20%20%20range.endContainer%2C%20range.endOffset%29%3B%5Cn%20%20_insert_char%28START_RANGE_MARKER%2C%5Cn%20%20%20%20range.startContainer%2C%20range.startOffset%29%3B%5Cn%7D%5Cn%5Cn/%2A%5Cn%2A%20inserts%20a%20char%20into%20a%20text%20node%20%28%40container%29%20at%20a%20given%20offset%5Cn%2A/%5Cnfunction%20_insert_char%28char%2C%20container%2C%20offset%29%7B%5Cn%20%20var%20cursor%2C%20node%3B%5Cn%20%20cursor%20%3D%20document.createRange%28%29%3B%5Cn%20%20cursor.setStart%28container%2C%20offset%29%3B%5Cn%20%20node%20%3D%20document.createTextNode%28char%29%3B%5Cn%20%20cursor.insertNode%28node%29%3B%5Cn%7D%5Cn%60%60%60%5Cn%5Cn%23%23%23%23%23%20Cursor%20restoring%20function%5Cn%5CnI%20use%20a%20helper%20method%20to%20find%20the%20position%20of%20a%20given%20character%20before%20removing%20it%2C%20and%20use%20this%20to%20restore%20the%20selection.%5Cn%5Cn%60%60%60%5Cn/%2A%5Cn%2A%20restore%20the%20cursor%20or%20selection%20placed%20by%20%60mark_cursor%60%5Cn%2A/%5Cnfunction%20restore_cursor%28%29%7B%5Cn%20%20var%20temp%2C%20range%2C%20start_node%2C%5Cn%20%20%20%20%20%20start_offset%2C%20end_node%2C%20end_offset%3B%5Cn%5Cn%20%20range%20%3D%20document.createRange%28%29%5Cn%5Cn%20%20temp%20%3D%20_find_and_remove_marker%28START_RANGE_MARKER%2C%20editable_div%29%3B%5Cn%20%20start_node%20%3D%20temp%5B0%5D%3B%5Cn%20%20start_offset%20%3D%20temp%5B1%5D%3B%5Cn%5Cn%20%20temp%20%3D%20_find_and_remove_marker%28END_RANGE_MARKER%2C%20editable_div%29%3B%5Cn%20%20end_node%20%3D%20temp%5B0%5D%3B%5Cn%20%20end_offset%20%3D%20temp%5B1%5D%3B%5Cn%5Cn%20%20range.setStart%28start_node%2C%20start_offset%29%3B%5Cn%20%20range.setEnd%28end_node%2C%20end_offset%29%3B%5Cn%5Cn%20%20sel%20%3D%20document.getSelection%28%29%3B%5Cn%20%20sel.removeAllRanges%28%29%3B%5Cn%20%20sel.addRange%28range%29%3B%5Cn%7D%5Cn%5Cn/%2A%5Cn%2A%20Note%3A%20TreeWalker%20provides%20a%20more%20succinct%20and%20efficient%20way%20to%5Cn%2A%20search%20the%20node%20tree.%20In%20an%20attempt%20to%20minimize%20the%20number%20of%5Cn%2A%20APIs%20used%2C%20I%27m%20doing%20some%20simple%20recursion%20to%20walk%20to%20tree%5Cn%2A/%5Cn/%2A%5Cn%2A%20this%20method%20finds%20the%20first%20instance%20of%20%40marker%20in%20%40root_node%2C%5Cn%2A%20removes%20it%2C%20and%20returns%20the%20container%20node%20and%20offset%20of%20the%5Cn%2A%20location%20being%20marked%20as%20a%20tuple%5Cn%2A/%5Cnfunction%20_find_and_remove_marker%28marker%2C%20root_node%29%7B%5Cn%20%20var%20node%2C%20i%2C%20offset%2C%20result%2C%20children%3B%5Cn%20%20if%20%28root_node.nodeValue%20%21%3D%20null%29%7B%5Cn%20%20%20%20offset%20%3D%20root_node.nodeValue.indexOf%28marker%29%3B%5Cn%20%20%20%20if%20%28offset%20%3E%3D%200%29%20%7B%5Cn%20%20%20%20%20%20root_node.nodeValue%20%3D%5Cn%20%20%20%20%20%20%20%20root_node.nodeValue.substr%280%2C%20offset%29%20%2B%5Cn%20%20%20%20%20%20%20%20root_node.nodeValue.substr%28offset%2B1%29%3B%5Cn%20%20%20%20%20%20return%20%5Broot_node%2C%20offset%5D%3B%5Cn%20%20%20%20%7D%5Cn%20%20%7D%20else%20%7B%5Cn%20%20%20%20children%20%3D%20root_node.childNodes%3B%5Cn%20%20%20%20for%20%28var%20i%20in%20children%29%7B%5Cn%20%20%20%20%20%20node%20%3D%20children%5Bi%5D%3B%5Cn%20%20%20%20%20%20result%20%3D%20_find_and_remove_marker%28marker%2C%20node%29%3B%5Cn%20%20%20%20%20%20if%20%28result%20%21%3D%20null%29%5Cn%20%20%20%20%20%20%20%20return%20result%5Cn%20%20%20%20%7D%5Cn%20%20%7D%5Cn%20%20return%20null%5Cn%7D%5Cn%60%60%60%5Cn%5Cn%23%23%23%23%23%20Finished%20%5C%22textarea%5C%22%20with%20highlighted%20at-mentions%5Cn%5Cn%3Ciframe%20src%3D%5C%22example6.html%5C%22%20style%3D%5C%22height%3A54px%5C%22%20sandbox%3D%5C%22allow-scripts%5C%22%3E%5Cn%3C/iframe%3E%5Cn%3Cdiv%20style%3D%5C%22float%3Aright%5C%22%3E%5Cn%3Ca%20href%3D%5C%22example6.html%5C%22%20target%3D%5C%22_blank%5C%22%3Eexample6.html%3C/a%3E%5Cn%28%20%3Ca%20href%3D%5C%22/static/source_viewer_dyn.html%23/blog/2015-12-22_rich_input/example6.html%5C%22%20target%3D%5C%22_blank%5C%22%3Efull%20source%3C/a%3E%20%29%5Cn%3C/div%3E%5Cn%3Cdiv%20style%3D%5C%22clear%3Aboth%5C%22%3E%3C/div%3E%5Cn%5Cn%23%23%23%23%20Caveats%20and%20Gotchas%5Cn%5Cn-%20instead%20of%20%5B%60contenteditable%3D%5C%22true%5C%22%60%5D%28https%3A//w3c.github.io/editing/contentEditableTrue.html%29%2C%20%5B%60contenteditable%3Dtyping%60%5D%28http%3A//w3c.github.io/editing/contentEditable.html%23caret-state%29%20may%20be%20the%20right%20choice%2C%20but%20I%20haven%27t%20played%20with%20it%20enough.%5Cn%5Cn-%20undo%20is%20broken%20in%20these%20examples.%20There%20is%20a%20thing%20called%20%5BUndoManager%5D%28http%3A//www.w3.org/TR/2008/WD-html5-20080610/editing.html%23undomanager%29%20that%20can%20help.%20It%20would%20need%20its%20own%20post.%20I%27m%20ignoring%20it%20for%20this%20example.%5Cn%5Cn-%20Things%20like%20what%20happens%20when%20you%20hit%20enter%20%28newline%3F%20%60%3Cbr%3E%60%3F%20%60%3Cp%3E%60%3F%29%20are%20TOTALLY%20DIFFERENT%20in%20different%20browsers.%20I%20don%27t%20handle%20line%20breaks%20correctly%20in%20these%20examples.%5Cn%5Cn-%20Every%20user%20agent%20has%20it%27s%20own%20pile%20of%20legacy%20methods.%20The%20fiddle-till-it-works%20approach%20ends%20badly.%5Cn%5Cn-%20%60%5Bselection%5D.anchorNode%60%20is%20a%20thing.%20%60%5Bselection%5D.baseNode%60%20is%20only%20a%20thing%20in%20some%20user%20agents.%5Cn%5Cn%23%23%20next%20post%3A%20adding%20emoji%20/%20auto-complete%5Cn%5Cnpart%202%20coming%20roughly%20%5C%22when%20I%20get%20around%20to%20writing%20it%5C%22%5Cn%5Cn%5Cn%3Cdiv%20id%3D%5C%22disqus_thread%5C%22%3E%3C/div%3E%5Cn%22</script>

<script>
window.showTableOfContents = true;

  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-67884085-1', 'auto');
  ga('send', 'pageview');

</script>
</head>

<body id="render-target">
    <div class="wrapper">
        <header class="">
            <div id="header-background">
            </div>
            <div id="header-content">
                <div class="title"><a href="/">stein</a></div>
                <ul>
                    <li><a href="/blog">blog</a></li>
                    <li><a href="/about">about</a></li>
                </ul>
            </div>
        </header>
        <div id="content-wrapper">
            <div id="content-wrapper-bg"></div>
<div id="content-wrapper-fg"><div><div class="cm-table-of-contents"><div class="cm-toc-item"><a href="#section-1"><div class="cm-toc-item-section-id">1</div><div class="cm-toc-item-section-title">Getting to know  contenteditable</div></a></div><div class="cm-toc-item"><a href="#section-2"><div class="cm-toc-item-section-id">2</div><div class="cm-toc-item-section-title">Setting up a text input</div></a></div><div class="cm-toc-item"><a href="#section-2.1"><div class="cm-toc-item-section-id">2.1</div><div class="cm-toc-item-section-title">Restricting input to plain text</div></a></div><div class="cm-toc-item"><a href="#section-2.2"><div class="cm-toc-item-section-id">2.2</div><div class="cm-toc-item-section-title">Finding the cursor</div></a></div><div class="cm-toc-item"><a href="#section-2.3"><div class="cm-toc-item-section-id">2.3</div><div class="cm-toc-item-section-title">Handling pasted content</div></a></div><div class="cm-toc-item"><a href="#section-3"><div class="cm-toc-item-section-id">3</div><div class="cm-toc-item-section-title">Putting it together: building a rich text input area</div></a></div><div class="cm-toc-item"><a href="#section-3.1"><div class="cm-toc-item-section-id">3.1</div><div class="cm-toc-item-section-title">Preserving cursor position</div></a></div><div class="cm-toc-item"><a href="#section-4"><div class="cm-toc-item-section-id">4</div><div class="cm-toc-item-section-title">next post: adding emoji / auto-complete</div></a></div></div><div class="cm-react-div"><div class="cm-react-div"><h1 class="cm-react-header"><span class="cm-react-text">Making rich text input for the web.</span></h1><p class="cm-react-p"><strong class="cm-react-strong"><span class="cm-react-text">tl;dr:</span></strong><span class="cm-react-text"> Here</span><span class="cm-react-text">'</span><span class="cm-react-text">s an </span><a class="cm-react-link" href="example7.html" title="" target="_blank"><span class="cm-react-text">example</span></a><span class="cm-react-text">. Here</span><span class="cm-react-text">'</span><span class="cm-react-text">s the </span><a class="cm-react-link" href="/static/source_viewer_dyn.html#/blog/2015-12-22_rich_input/example7.html" title="" target="_blank"><span class="cm-react-text">source</span></a><span class="cm-react-text">.</span></p><p class="cm-react-p"><span class="cm-react-text">I recently set out to build a rich input box, assuming some googling and stack overflow articles would be enough to get started. I found a lot of content on how bad the tools the browser gives you are. I found less help on how to get started building something. This is an attempt to document my initial learnings from building simple rich text editing on the web.</span></p><p class="cm-react-p"><span class="cm-react-text">There are two big parts of building a rich editing experience. The first is detecting the content a user inputs, the second is displaying that content. I knew enough CSS and HTML to get content on a page; this post focuses mostly on capturing input cleanly.</span></p><p class="cm-react-p"><span class="cm-react-text">A kind-of-standard for managing user input is the </span><code class="cm-react-code hljs">contenteditable</code><span class="cm-react-text"> attribute, which as far as I can tell is an artifact of an Internet Explorer 5.5 feature for editing emails in Outlook Online. The feature was </span><a class="cm-react-link" href="https://bugzilla.mozilla.org/show_bug.cgi?id=97284" title="" target="_blank"><span class="cm-react-text">sort-of-cloned</span></a><span class="cm-react-text"> by other browsers. It</span><span class="cm-react-text">'</span><span class="cm-react-text">s </span><a class="cm-react-link" href="https://codemirror.net/doc/internals.html" title="" target="_blank"><span class="cm-react-text">bug ridden</span></a><span class="cm-react-text"> at best and </span><a class="cm-react-link" href="https://medium.com/medium-eng/why-contenteditable-is-terrible-122d8a40e480" title="" target="_blank"><span class="cm-react-text">broken by design</span></a><span class="cm-react-text"> at worst. It</span><span class="cm-react-text">'</span><span class="cm-react-text">s also very powerful if you can avoid the messy parts.</span></p><p class="cm-react-p"><span class="cm-react-text">There many great </span><a class="cm-react-link" href="https://github.com/ajaxorg/ace" title="" target="_blank"><span class="cm-react-text">open</span></a><span class="cm-react-text"> </span><a class="cm-react-link" href="https://codemirror.net/" title="" target="_blank"><span class="cm-react-text">source</span></a><span class="cm-react-text"> </span><a class="cm-react-link" href="https://github.com/dropbox/hackpad" title="" target="_blank"><span class="cm-react-text">projects</span></a><span class="cm-react-text"> that have a robust approach to fully-featured rich text editing. I was more interested in building some basic functionality (autocomplete and at-mentioning) without loading an entire text editor before page load.</span></p><hr class="cm-horizontal-rule"><h2 class="cm-react-header"><a name="section-1" class="cm-section-id">1</a><span class="cm-react-text">Getting to know </span><code class="cm-react-code hljs">contenteditable</code></h2><p class="cm-react-p"><span class="cm-react-text">It</span><span class="cm-react-text">'</span><span class="cm-react-text">s worth playing with </span><code class="cm-react-code hljs">contenteditable</code><span class="cm-react-text"> a little.</span></p><p class="cm-react-p"><span class="cm-react-text">I</span><span class="cm-react-text">'</span><span class="cm-react-text">ve iframe</span><span class="cm-react-text">'</span><span class="cm-react-text">d in an div with the contenteditable flag set, I</span><span class="cm-react-text">'</span><span class="cm-react-text">d recommend using the link beneath it to try it in a new tab. Here are some things to try:</span></p><ul class="cm-react-list"><li class="cm-react-li"><p class="cm-react-p"><span class="cm-react-text">type into the box.</span></p></li><li class="cm-react-li"><p class="cm-react-p"><span class="cm-react-text">copy and paste part of a website. Images, formatting, potentially some javascript (</span><code class="cm-react-code hljs ini"><span class="hljs-setting"><span class="hljs-setting">onclick=</span><span class="hljs-value"></span></span><span class="hljs-setting"><span class="hljs-value"></span></span></code><span class="cm-react-text">, for example)</span></p></li><li class="cm-react-li"><p class="cm-react-p"><span class="cm-react-text">copy something with complex CSS (ie, explicit positioning). Stuff can escape the box.</span></p></li></ul><pre class="cm-react-codeblock-wrapper"><code class="cm-react-codeblock hljs xml"><span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-title"><span class="hljs-tag"><span class="hljs-title">html</span></span></span><span class="hljs-tag">&gt;</span></span>
  <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-title"><span class="hljs-tag"><span class="hljs-title">body</span></span></span><span class="hljs-tag">&gt;</span></span>
    <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-title"><span class="hljs-tag"><span class="hljs-title">div</span></span></span><span class="hljs-tag"> </span><span class="hljs-attribute"><span class="hljs-tag"><span class="hljs-attribute">contenteditable</span></span></span><span class="hljs-tag">=</span><span class="hljs-value"><span class="hljs-tag"><span class="hljs-value">"true"</span></span></span><span class="hljs-tag">&gt;</span></span>
      editable content!
    <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-title"><span class="hljs-tag"><span class="hljs-title">div</span></span></span><span class="hljs-tag">&gt;</span></span>
  <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-title"><span class="hljs-tag"><span class="hljs-title">body</span></span></span><span class="hljs-tag">&gt;</span></span>
<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-title"><span class="hljs-tag"><span class="hljs-title">html</span></span></span><span class="hljs-tag">&gt;</span></span>
</code></pre><div class="cm-react-html"><iframe src="example1.html" sandbox="">
   this must be multiple lines
</iframe>
<div style="float:right">
<a href="example1.html" target="_blank">example1.html</a>
( <a href="/static/source_viewer_dyn.html#/blog/2015-12-22_rich_input/example1.html" target="_blank">full source</a> )
</div>
<div style="clear:both"></div></div><h2 class="cm-react-header"><a name="section-2" class="cm-section-id">2</a><span class="cm-react-text">Setting up a text input</span></h2><p class="cm-react-p"><span class="cm-react-text">My first goal is to build something that behaves like a </span><code class="cm-react-code hljs">textarea</code><span class="cm-react-text">. Pretty much any box that allows only text input and has a cursor location will work. I</span><span class="cm-react-text">'</span><span class="cm-react-text">m going to use a </span><code class="cm-react-code hljs">div</code><span class="cm-react-text"> with the </span><code class="cm-react-code hljs">contenteditable</code><span class="cm-react-text"> flag set to manage the cursor, and then restrict behavior to only allow plain text.</span></p><h3 class="cm-react-header"><a name="section-2.1" class="cm-section-id">2.1</a><span class="cm-react-text">Restricting input to plain text</span></h3><p class="cm-react-p"><span class="cm-react-text">Starting with the box in the first example, I now want to restrict the contents of the box to </span><em class="cm-react-em"><span class="cm-react-text">only be text</span></em><span class="cm-react-text">. On some webkit browsers the attr </span><code class="cm-react-code hljs ini"><span class="hljs-setting"><span class="hljs-setting">contenteditable=</span><span class="hljs-value"><span class="hljs-string"><span class="hljs-setting"><span class="hljs-value"><span class="hljs-string">"plaintext-only"</span></span></span></span></span></span></code><span class="cm-react-text"> does this; not all browsers are webkit.</span></p><p class="cm-react-p"><span class="cm-react-text">My approach is to capture any insertion that </span><em class="cm-react-em"><span class="cm-react-text">isn</span><span class="cm-react-text">'</span><span class="cm-react-text">t a single character resulting from a keystroke</span></em><span class="cm-react-text"> and define some custom behavior. This means I need to detect </span><strong class="cm-react-strong"><span class="cm-react-text">drag/drop</span></strong><span class="cm-react-text"> and </span><strong class="cm-react-strong"><span class="cm-react-text">paste</span></strong><span class="cm-react-text"> events. According to the docs these insertions always trigger </span><a class="cm-react-link" href="http://www.w3.org/TR/2008/WD-html5-20080610/editing.html#paste" title="" target="_blank"><span class="cm-react-text">a drop event</span></a><span class="cm-react-text">. In practice, I need to listen for </span><code class="cm-react-code hljs">paste</code><span class="cm-react-text"> events as well.</span></p><pre class="cm-react-codeblock-wrapper"><code class="cm-react-codeblock hljs javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">paste_event_handler</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">e</span></span></span><span class="hljs-function">)</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> raw_text, raw_data, paste_data;

  <span class="hljs-comment"><span class="hljs-comment">// prevent the paste from happening</span></span>
  e.preventDefault();

  <span class="hljs-comment"><span class="hljs-comment">// try to get the data from a DragEvent</span></span>
  raw_data = e.dataTransfer;

  <span class="hljs-comment"><span class="hljs-comment">// fall back to data from a ClipboardEvent</span></span>
  paste_data = e.clipboardData;
  raw_data = raw_data || paste_data;

  <span class="hljs-comment"><span class="hljs-comment">// extract the raw text from the pasted data</span></span>
  raw_text = raw_data.getData(<span class="hljs-string"><span class="hljs-string">"Text"</span></span>);
  <span class="hljs-built_in"><span class="hljs-built_in">console</span></span>.log(raw_text);
};

<span class="hljs-comment"><span class="hljs-comment">// set up listeners for `drop` and `paste` events</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> editable_div = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getElementById(<span class="hljs-string"><span class="hljs-string">"my-editable-div"</span></span>);
editable_div.addEventListener(<span class="hljs-string"><span class="hljs-string">"drop"</span></span>, paste_event_handler);
editable_div.addEventListener(<span class="hljs-string"><span class="hljs-string">"paste"</span></span>, paste_event_handler);
</code></pre><div class="cm-react-html"><iframe src="example2.html" sandbox="allow-scripts">
</iframe>
<div style="float:right">
<a href="example2.html" target="_blank">example2.html</a>
( <a href="/static/source_viewer_dyn.html#/blog/2015-12-22_rich_input/example2.html" target="_blank">full source</a> )
</div>
<div style="clear:both"></div></div><blockquote class="cm-react-blockquote"><p class="cm-react-p"><span class="cm-react-text">Here</span><span class="cm-react-text">'</span><span class="cm-react-text">s an experiment that suppresses any input that isn</span><span class="cm-react-text">'</span><span class="cm-react-text">t normal typing, instead logging the content to the console. No need to open a dev console, output is captured and displayed on the page. On most browsers, drag-drop from outside an iFrame is suppressed.</span></p></blockquote><h3 class="cm-react-header"><a name="section-2.2" class="cm-section-id">2.2</a><span class="cm-react-text">Finding the cursor</span></h3><p class="cm-react-p"><span class="cm-react-text">According to the </span><a class="cm-react-link" href="http://www.w3.org/TR/2008/WD-html5-20080610/editing.html" title="" target="_blank"><span class="cm-react-text">w3c working draft</span></a><span class="cm-react-text">, when an editable element has focus it has a cursor or selection. You can check on the cursor or selection</span><span class="cm-react-text">'</span><span class="cm-react-text">s position programmatically.</span></p><p class="cm-react-p"><span class="cm-react-text">Before inserting content at the cursor, I needed to understand the structure of selection ranges and how to manipulate them. I</span><span class="cm-react-text">'</span><span class="cm-react-text">ll review the basics, but you can </span><a class="cm-react-link" href="#section-2.3" title=""><span class="cm-react-text">skip ahead</span></a><span class="cm-react-text">.</span></p><h4 class="cm-react-header"><span class="cm-react-text">Nodes, Selections, and Ranges</span></h4><p class="cm-react-p"><span class="cm-react-text">The content of a div is composed of a set of </span><a class="cm-react-link" href="http://www.w3.org/2003/01/dom2-javadoc/org/w3c/dom/Node.html" title="" target="_blank"><span class="cm-react-text">Nodes</span></a><span class="cm-react-text"> (as is the rest of the DOM). For my purposes there are two types of nodes:</span></p><ul class="cm-react-list"><li class="cm-react-li"><p class="cm-react-p"><strong class="cm-react-strong"><span class="cm-react-text">text nodes</span></strong><span class="cm-react-text"> - blocks of text. don</span><span class="cm-react-text">'</span><span class="cm-react-text">t have any additional markup</span></p></li><li class="cm-react-li"><p class="cm-react-p"><strong class="cm-react-strong"><span class="cm-react-text">elements</span></strong><span class="cm-react-text"> - the DOM nodes we manipulate all the time (divs, spans, etc)</span></p></li></ul><p class="cm-react-p"><span class="cm-react-text">If there is focus on the page, it is represented as a </span><code class="cm-react-code hljs">Range</code><span class="cm-react-text">. A range has a start location and an end location, called </span><a class="cm-react-link" href="http://www.w3.org/TR/DOM-Level-2-Traversal-Range/ranges.html#Level-2-Range-Position" title="" target="_blank"><span class="cm-react-text">boundary points</span></a><span class="cm-react-text">). A boundary point is defined by a node and an offset.</span></p><p class="cm-react-p"><span class="cm-react-text">In a text node a </span><em class="cm-react-em"><span class="cm-react-text">boundary point</span></em><span class="cm-react-text"> is effectively an index into a string: the boundary point is immediately after the </span><span class="cm-react-text">&lt;</span><code class="cm-react-code hljs">offset</code><span class="cm-react-text">&gt;th character in the string (or before the first char if offset = 0).</span></p><p class="cm-react-p"><span class="cm-react-text">In an elements, the boundary point lies between nodes immediately after the </span><span class="cm-react-text">&lt;</span><code class="cm-react-code hljs">offset</code><span class="cm-react-text">&gt;th child node.</span></p><p class="cm-react-p"><span class="cm-react-text">I found this easier to understand after playing with it, I</span><span class="cm-react-text">'</span><span class="cm-react-text">ve written a tool for playing with boundary points. Different browsers will behave slightly differently along the boundaries between nodes, but the way in which indexing works should stay the same.</span></p><p class="cm-react-p"><span class="cm-react-text">In this demo, there is a graphical representation of the nodes, with red and green dots at the boundary points when the box has focus.</span></p><pre class="cm-react-codeblock-wrapper"><code class="cm-react-codeblock hljs xml"><span class="hljs-comment"><span class="hljs-comment">&lt;!-- raw html from example --&gt;</span></span>
  try
  <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-title"><span class="hljs-tag"><span class="hljs-title">span</span></span></span><span class="hljs-tag"> </span><span class="hljs-attribute"><span class="hljs-tag"><span class="hljs-attribute">style</span></span></span><span class="hljs-tag">=</span><span class="hljs-value"><span class="hljs-tag"><span class="hljs-value">"color: red"</span></span></span><span class="hljs-tag">&gt;</span></span>
    <span class="hljs-tag"><span class="hljs-tag">&lt;</span><span class="hljs-title"><span class="hljs-tag"><span class="hljs-title">b</span></span></span><span class="hljs-tag">&gt;</span></span> highlight<span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-title"><span class="hljs-tag"><span class="hljs-title">b</span></span></span><span class="hljs-tag">&gt;</span></span>
    ing or clicking parts of
  <span class="hljs-tag"><span class="hljs-tag">&lt;/</span><span class="hljs-title"><span class="hljs-tag"><span class="hljs-title">span</span></span></span><span class="hljs-tag">&gt;</span></span>
  this sentence
</code></pre><div class="cm-react-html"><iframe src="example3.html" style="height:320px" sandbox="allow-scripts">
</iframe>
<a href="example3.html" target="_blank" style="float:right">example3.html</a>
<div style="clear:both"></div></div><p class="cm-react-p"><span class="cm-react-text">Notice that </span><span class="cm-react-text">"</span><span class="cm-react-text">this</span><span class="cm-react-text">"</span><span class="cm-react-text"> and </span><span class="cm-react-text">"</span><span class="cm-react-text">sentence</span><span class="cm-react-text">"</span><span class="cm-react-text"> are different nodes even though they are the same chunk of HTML. Try typing, and using ctrl+i and ctrl+b to bold and italify text. Depending on your browser, you may be able to position boundary points </span><em class="cm-react-em"><span class="cm-react-text">between</span></em><span class="cm-react-text"> the text nodes or element boundaries. Each browser is a little different in their implementation of this behavior.</span></p><blockquote class="cm-react-blockquote"><p class="cm-react-p"><span class="cm-react-text">The </span><code class="cm-react-code hljs">normalize</code><span class="cm-react-text"> function tries to join text</span><span class="cm-react-text">_</span><span class="cm-react-text">nodes when they appear next to each other. You can call it on a parent node that contains multiple child nodes.</span></p></blockquote><h4 class="cm-react-header"><span class="cm-react-text">List of useful commands for manipulating selection ranges</span></h4><p class="cm-react-p"><span class="cm-react-text">I need to manipulate selection ranges as I mutate the div to make the text </span><span class="cm-react-text">"</span><span class="cm-react-text">rich</span><span class="cm-react-text">"</span><span class="cm-react-text">. The selection and range APIs can do a lot of things - these are the fields and functions I use over the rest of this post to work with selections.</span></p><ul class="cm-react-list"><li class="cm-react-li"><p class="cm-react-p"><code class="cm-react-code hljs coffeescript"><span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getSelection()</code></p><p class="cm-react-p"><span class="cm-react-text">Returns a </span><code class="cm-react-code hljs">Selection</code><span class="cm-react-text">, which represents the current selection in the document; contains zero or more </span><code class="cm-react-code hljs">Range</code><span class="cm-react-text">'</span><span class="cm-react-text">s</span></p></li><li class="cm-react-li"><p class="cm-react-p"><code class="cm-react-code hljs css"><span class="hljs-tag"><span class="hljs-tag">Selection</span></span><span class="hljs-class"><span class="hljs-class">.rangeCount</span></span></code></p><p class="cm-react-p"><span class="cm-react-text">the number of </span><code class="cm-react-code hljs">Range</code><span class="cm-react-text">'</span><span class="cm-react-text">s in the selection. This is either 0 or 1 in almost every practical situation.</span></p><p class="cm-react-p"><em class="cm-react-em"><span class="cm-react-text">There are some rare cases when </span><code class="cm-react-code hljs cpp">rangeCount &gt; <span class="hljs-number"><span class="hljs-number">1</span></span></code><span class="cm-react-text">. The most common is when the user selects some text with one input device (ie, a mouse) and then moves focus with another device (ie, hitting tab on a keyboard) - resulting in two selection ranges. For this post, I</span><span class="cm-react-text">'</span><span class="cm-react-text">ll assume that there is at most one range. In practice you will have to handle higher </span><code class="cm-react-code hljs">rangeCount</code><span class="cm-react-text">s by checking which elements have focus.</span></em></p></li><li class="cm-react-li"><p class="cm-react-p"><code class="cm-react-code hljs css"><span class="hljs-tag"><span class="hljs-tag">Range</span></span><span class="hljs-class"><span class="hljs-class">.startContainer</span></span></code><span class="cm-react-text">, </span><code class="cm-react-code hljs css"><span class="hljs-tag"><span class="hljs-tag">Range</span></span><span class="hljs-class"><span class="hljs-class">.startOffset</span></span></code><span class="cm-react-text">, </span><code class="cm-react-code hljs css"><span class="hljs-tag"><span class="hljs-tag">Range</span></span><span class="hljs-class"><span class="hljs-class">.endContainer</span></span></code><span class="cm-react-text">, </span><code class="cm-react-code hljs css"><span class="hljs-tag"><span class="hljs-tag">Range</span></span><span class="hljs-class"><span class="hljs-class">.endOffset</span></span></code></p><p class="cm-react-p"><span class="cm-react-text">The (node, offset) pairs defining a range.</span></p></li><li class="cm-react-li"><p class="cm-react-p"><code class="cm-react-code hljs css"><span class="hljs-tag"><span class="hljs-tag">Range</span></span><span class="hljs-class"><span class="hljs-class">.deleteContents</span></span>()</code></p><p class="cm-react-p"><span class="cm-react-text">Delete the content between the boundaries, removing any nodes that are contained completely between those two points.</span></p></li><li class="cm-react-li"><p class="cm-react-p"><code class="cm-react-code hljs css"><span class="hljs-tag"><span class="hljs-tag">Range</span></span><span class="hljs-class"><span class="hljs-class">.insertNode</span></span>(<span class="hljs-tag"><span class="hljs-tag">node</span></span>)</code></p><p class="cm-react-p"><span class="cm-react-text">Inserts a node immediately after the start boundary, splitting any text nodes into multiple nodes and pushing any other boundary points to the end of the inserted node.</span></p><p class="cm-react-p"><em class="cm-react-em"><span class="cm-react-text">before insert</span></em><span class="cm-react-text"> - </span><code class="cm-react-code hljs apache"><span class="hljs-tag"><span class="hljs-tag">&lt;start1&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;start2&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;end1&gt;</span></span></code><span class="cm-react-text"> </span><strong class="cm-react-strong"><span class="cm-react-text">content</span></strong><span class="cm-react-text"> </span><code class="cm-react-code hljs apache"><span class="hljs-tag"><span class="hljs-tag">&lt;end2&gt;</span></span></code></p><p class="cm-react-p"><em class="cm-react-em"><span class="cm-react-text">after insert</span></em><span class="cm-react-text"> - </span><code class="cm-react-code hljs apache"><span class="hljs-tag"><span class="hljs-tag">&lt;start1&gt;</span></span></code><span class="cm-react-text"> </span><span class="cm-react-text">&lt;</span><span class="cm-react-text">INSERTED</span><span class="cm-react-text">_</span><span class="cm-react-text">NODE&gt; </span><code class="cm-react-code hljs apache"><span class="hljs-tag"><span class="hljs-tag">&lt;start2&gt;</span></span><span class="hljs-tag"><span class="hljs-tag">&lt;end1&gt;</span></span></code><span class="cm-react-text"> </span><strong class="cm-react-strong"><span class="cm-react-text">content</span></strong><span class="cm-react-text"> </span><code class="cm-react-code hljs apache"><span class="hljs-tag"><span class="hljs-tag">&lt;end2&gt;</span></span></code></p></li><li class="cm-react-li"><p class="cm-react-p"><code class="cm-react-code hljs css"><span class="hljs-tag"><span class="hljs-tag">Range</span></span><span class="hljs-class"><span class="hljs-class">.setStart</span></span>(<span class="hljs-tag"><span class="hljs-tag">node</span></span>, <span class="hljs-tag"><span class="hljs-tag">offset</span></span>)</code><span class="cm-react-text">, </span><code class="cm-react-code hljs css"><span class="hljs-tag"><span class="hljs-tag">Range</span></span><span class="hljs-class"><span class="hljs-class">.setEnd</span></span>(<span class="hljs-tag"><span class="hljs-tag">node</span></span>, <span class="hljs-tag"><span class="hljs-tag">offset</span></span>)</code></p><p class="cm-react-p"><span class="cm-react-text">Adjust the boundaries.</span></p></li><li class="cm-react-li"><p class="cm-react-p"><code class="cm-react-code hljs css"><span class="hljs-tag"><span class="hljs-tag">Node</span></span><span class="hljs-class"><span class="hljs-class">.normalize</span></span>()</code></p><p class="cm-react-p"><span class="cm-react-text">Combine adjacent child text nodes into a single node.</span></p></li></ul><h3 class="cm-react-header"><a name="section-2.3" class="cm-section-id">2.3</a><span class="cm-react-text">Handling pasted content</span></h3><p class="cm-react-p"><span class="cm-react-text">Using this API, I add functionality for pasting and dropping content back into the input box. I </span><em class="cm-react-em"><span class="cm-react-text">only insert the text</span></em><span class="cm-react-text">, ignoring styling and formatting.</span></p><pre class="cm-react-codeblock-wrapper"><code class="cm-react-codeblock hljs javascript"><span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">get_range</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> sel = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getSelection();
  <span class="hljs-comment"><span class="hljs-comment">// rangeCount is 0 if nothing is selected (ie, we do</span></span>
  <span class="hljs-comment"><span class="hljs-comment">// not have user focus)</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (sel.rangeCount === <span class="hljs-number"><span class="hljs-number">0</span></span>) {
    <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;
  }
  <span class="hljs-comment"><span class="hljs-comment">// if the browser allows multiple simultaneous selections,</span></span>
  <span class="hljs-comment"><span class="hljs-comment">// much of this example needs to be fancier. Luckily most</span></span>
  <span class="hljs-comment"><span class="hljs-comment">// browsers don't allow that while editing text.</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> sel.getRangeAt(<span class="hljs-number"><span class="hljs-number">0</span></span>);
}

<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">insert_text_at_cursor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">text</span></span></span><span class="hljs-function">)</span></span>{
  <span class="hljs-comment"><span class="hljs-comment">// get user selection, if there is any</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> range = get_range();
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (!range) <span class="hljs-keyword"><span class="hljs-keyword">return</span></span>;

  <span class="hljs-comment"><span class="hljs-comment">// delete the selection if needed</span></span>
  range.deleteContents();

  <span class="hljs-comment"><span class="hljs-comment">// insert text</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> text_node = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createTextNode(text);
  range.insertNode(text_node);

  <span class="hljs-comment"><span class="hljs-comment">// the "start" of our range is now before the inserted text,</span></span>
  <span class="hljs-comment"><span class="hljs-comment">// we need to move it to the end...</span></span>
  range.setStart(range.endContainer, range.endOffset);

  <span class="hljs-comment"><span class="hljs-comment">// ...and then force user focus to that range</span></span>
  <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getSelection().removeAllRanges()
  <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getSelection().addRange(range)
}

</code></pre><div class="cm-react-html"><iframe src="example4.html" style="height:54px" sandbox="allow-scripts">
</iframe>
<div style="float:right">
<a href="example4.html" target="_blank">example4.html</a>
( <a href="/static/source_viewer_dyn.html#/blog/2015-12-22_rich_input/example4.html" target="_blank">full source</a> )
</div>
<div style="clear:both"></div></div><p class="cm-react-p"><span class="cm-react-text">Some things are not suppressed here: a user can still add emphasis to text on most user agents (ctrl+b on desktop, for example). Rather than catching those cases, I am going to add some heavy-handed formatting logic that overwrites any of the formatting behavior provided by the user agent.</span></p><p class="cm-react-p"></p><div class="cm-react-html"><a name="cursor"></a></div><div class="cm-react-html"></div><p></p><h2 class="cm-react-header"><a name="section-3" class="cm-section-id">3</a><span class="cm-react-text">Putting it together: building a rich text input area</span></h2><p class="cm-react-p"><span class="cm-react-text">Now that I have a </span><span class="cm-react-text">"</span><code class="cm-react-code hljs">textarea</code><span class="cm-react-text">"</span><span class="cm-react-text">  that mostly works, I</span><span class="cm-react-text">'</span><span class="cm-react-text">m ready to add some intelligence. For my demo I</span><span class="cm-react-text">'</span><span class="cm-react-text">d like to </span><strong class="cm-react-strong"><span class="cm-react-text">turn @-mentions blue</span></strong><span class="cm-react-text">.</span></p><p class="cm-react-p"><span class="cm-react-text">As a starting point, I just reformat the text after each keystroke. This doesn</span><span class="cm-react-text">'</span><span class="cm-react-text">t preserve cursor position. The textarea is almost unusable with the cursor jumping all over the place.</span></p><h4 class="cm-react-header"><span class="cm-react-text">Simple replacement code</span></h4><pre class="cm-react-codeblock-wrapper"><code class="cm-react-codeblock hljs javascript"><span class="hljs-keyword"><span class="hljs-keyword">var</span></span> AT_MENTION_REGEX = <span class="hljs-regexp"><span class="hljs-regexp">/((?!\w)@[\w]+)/g</span></span>;

<span class="hljs-comment"><span class="hljs-comment">/*
* Highlight @-mentions in the most naïve way
* possible - rebuild the entire div, clear
* and replace. Highly recommend you do something
* more efficient in practice :-)
*/</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">format_content</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{
  <span class="hljs-comment"><span class="hljs-comment">// editable_div is the editable DOM element</span></span>
  <span class="hljs-comment"><span class="hljs-comment">// (see example 2 and onwards)</span></span>
  <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> raw_content = editable_div.textContent;
  editable_div.innerHTML = raw_content.replace(
    AT_MENTION_REGEX,
    <span class="hljs-string"><span class="hljs-string">"&lt;span style='color:cyan'&gt;$1&lt;/span&gt;"</span></span>
  );
}

editable_div.addEventListener(<span class="hljs-string"><span class="hljs-string">"keyup"</span></span>, format_content);
</code></pre><div class="cm-react-html"><iframe src="example5.html" style="height:54px" sandbox="allow-scripts">
</iframe>
<div style="float:right">
<a href="example5.html" target="_blank">example5.html</a>
( <a href="/static/source_viewer_dyn.html#/blog/2015-12-22_rich_input/example5.html" target="_blank">full source</a> )
</div>
<div style="clear:both"></div></div><h3 class="cm-react-header"><a name="section-3.1" class="cm-section-id">3.1</a><span class="cm-react-text">Preserving cursor position</span></h3><p class="cm-react-p"><span class="cm-react-text">One way to avoid moving focus when mutating an editable region is to mark the cursor position. As three as the text is preserved, the markers should be as well. I do this in three steps</span></p><ol class="cm-react-list"><li class="cm-react-li"><p class="cm-react-p"><span class="cm-react-text">mark the beginning and end of the selection ranges using unique characters</span></p></li><li class="cm-react-li"><p class="cm-react-p"><span class="cm-react-text">mutate the contents</span></p></li><li class="cm-react-li"><p class="cm-react-p"><span class="cm-react-text">restore the selection and remove the markers</span></p></li></ol><p class="cm-react-p"><span class="cm-react-text">This breaks if the delimiter characters appear elsewhere in the content being edited. I work around this problem using </span><a class="cm-react-link" href="https://en.wikipedia.org/wiki/Private_Use_Areas" title="" target="_blank"><span class="cm-react-text">private use unicode characters</span></a><span class="cm-react-text">. I enforce that two reserved characters are never used in the textarea, that way I can use them as markers.</span></p><h5 class="cm-react-header"><span class="cm-react-text">Add calls to mark and restore the cursor</span></h5><p class="cm-react-p"><span class="cm-react-text">I start by adding </span><code class="cm-react-code hljs">mark_cursor</code><span class="cm-react-text"> and </span><code class="cm-react-code hljs">restore_cursor</code><span class="cm-react-text"> functions to the code from above.</span></p><pre class="cm-react-codeblock-wrapper"><code class="cm-react-codeblock hljs javascript"><span class="hljs-comment"><span class="hljs-comment">// set the markers</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> START_RANGE_MARKER = <span class="hljs-string"><span class="hljs-string">"\u0091"</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> END_RANGE_MARKER = <span class="hljs-string"><span class="hljs-string">"\u0092"</span></span>

<span class="hljs-comment"><span class="hljs-comment">// messy regex hack to stop the cursor from interfering</span></span>
<span class="hljs-comment"><span class="hljs-comment">// with matching mentions - in practice we should remove</span></span>
<span class="hljs-comment"><span class="hljs-comment">// the cursor markers before doing tokenization logic.</span></span>
<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> AT_MENTION_REGEX = <span class="hljs-regexp"><span class="hljs-regexp">/((?!\w)@[\w\u0091\u0092]+)/g</span></span>

<span class="hljs-comment"><span class="hljs-comment">/*
* Highlight @-mentions in the most naïve way possible - rebuild
* the entire div, clear and replace. Highly recommend you
* do something more efficient :-)
*/</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">format_content</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> raw_content;
  mark_cursor(); <span class="hljs-comment"><span class="hljs-comment">// implemented below</span></span>
  raw_content = editable_div.textContent;
  editable_div.innerHTML = raw_content.replace(
    AT_MENTION_REGEX,
    <span class="hljs-string"><span class="hljs-string">"&lt;span style='color:cyan'&gt;$1&lt;/span&gt;"</span></span>
  );
  restore_cursor(); <span class="hljs-comment"><span class="hljs-comment">// implemented below</span></span>
}
</code></pre><h5 class="cm-react-header"><span class="cm-react-text">Cursor marking function</span></h5><p class="cm-react-p"><span class="cm-react-text">I get the Selection and Range, and mark them with my reserved characters. Since the function above doesn</span><span class="cm-react-text">'</span><span class="cm-react-text">t remove characters, these will remain even after we format the text.</span></p><p class="cm-react-p"><span class="cm-react-text">For this example I use a helper function to insert the markers, in practice I use the same helper function to handle pasted text.</span></p><pre class="cm-react-codeblock-wrapper"><code class="cm-react-codeblock hljs javascript"><span class="hljs-comment"><span class="hljs-comment">/*
* marks the current location of the cursor or selection
*/</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">mark_cursor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> range = get_range();
  <span class="hljs-comment"><span class="hljs-comment">// The order matters here!</span></span>
  <span class="hljs-comment"><span class="hljs-comment">// See the notes on how Node.insertCursor() works</span></span>
  <span class="hljs-comment"><span class="hljs-comment">// above.</span></span>
  _insert_char(END_RANGE_MARKER,
    range.endContainer, range.endOffset);
  _insert_char(START_RANGE_MARKER,
    range.startContainer, range.startOffset);
}

<span class="hljs-comment"><span class="hljs-comment">/*
* inserts a char into a text node (@container) at a given offset
*/</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_insert_char</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">char, container, offset</span></span></span><span class="hljs-function">)</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> cursor, node;
  cursor = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createRange();
  cursor.setStart(container, offset);
  node = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createTextNode(char);
  cursor.insertNode(node);
}
</code></pre><h5 class="cm-react-header"><span class="cm-react-text">Cursor restoring function</span></h5><p class="cm-react-p"><span class="cm-react-text">I use a helper method to find the position of a given character before removing it, and use this to restore the selection.</span></p><pre class="cm-react-codeblock-wrapper"><code class="cm-react-codeblock hljs javascript"><span class="hljs-comment"><span class="hljs-comment">/*
* restore the cursor or selection placed by `mark_cursor`
*/</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">restore_cursor</span></span></span><span class="hljs-function">(</span><span class="hljs-params"></span><span class="hljs-function"><span class="hljs-params"></span>)</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> temp, range, start_node,
      start_offset, end_node, end_offset;

  range = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.createRange()

  temp = _find_and_remove_marker(START_RANGE_MARKER, editable_div);
  start_node = temp[<span class="hljs-number"><span class="hljs-number">0</span></span>];
  start_offset = temp[<span class="hljs-number"><span class="hljs-number">1</span></span>];

  temp = _find_and_remove_marker(END_RANGE_MARKER, editable_div);
  end_node = temp[<span class="hljs-number"><span class="hljs-number">0</span></span>];
  end_offset = temp[<span class="hljs-number"><span class="hljs-number">1</span></span>];

  range.setStart(start_node, start_offset);
  range.setEnd(end_node, end_offset);

  sel = <span class="hljs-built_in"><span class="hljs-built_in">document</span></span>.getSelection();
  sel.removeAllRanges();
  sel.addRange(range);
}

<span class="hljs-comment"><span class="hljs-comment">/*
* Note: TreeWalker provides a more succinct and efficient way to
* search the node tree. In an attempt to minimize the number of
* APIs used, I'm doing some simple recursion to walk to tree
*/</span></span>
<span class="hljs-comment"><span class="hljs-comment">/*
* this method finds the first instance of @marker in @root_node,
* removes it, and returns the container node and offset of the
* location being marked as a tuple
*/</span></span>
<span class="hljs-function"><span class="hljs-keyword"><span class="hljs-function"><span class="hljs-keyword">function</span></span></span><span class="hljs-function"> </span><span class="hljs-title"><span class="hljs-function"><span class="hljs-title">_find_and_remove_marker</span></span></span><span class="hljs-function">(</span><span class="hljs-params"><span class="hljs-function"><span class="hljs-params">marker, root_node</span></span></span><span class="hljs-function">)</span></span>{
  <span class="hljs-keyword"><span class="hljs-keyword">var</span></span> node, i, offset, result, children;
  <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (root_node.nodeValue != <span class="hljs-literal"><span class="hljs-literal">null</span></span>){
    offset = root_node.nodeValue.indexOf(marker);
    <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (offset &gt;= <span class="hljs-number"><span class="hljs-number">0</span></span>) {
      root_node.nodeValue =
        root_node.nodeValue.substr(<span class="hljs-number"><span class="hljs-number">0</span></span>, offset) +
        root_node.nodeValue.substr(offset+<span class="hljs-number"><span class="hljs-number">1</span></span>);
      <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> [root_node, offset];
    }
  } <span class="hljs-keyword"><span class="hljs-keyword">else</span></span> {
    children = root_node.childNodes;
    <span class="hljs-keyword"><span class="hljs-keyword">for</span></span> (<span class="hljs-keyword"><span class="hljs-keyword">var</span></span> i <span class="hljs-keyword"><span class="hljs-keyword">in</span></span> children){
      node = children[i];
      result = _find_and_remove_marker(marker, node);
      <span class="hljs-keyword"><span class="hljs-keyword">if</span></span> (result != <span class="hljs-literal"><span class="hljs-literal">null</span></span>)
        <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> result
    }
  }
  <span class="hljs-keyword"><span class="hljs-keyword">return</span></span> <span class="hljs-literal"><span class="hljs-literal">null</span></span>
}
</code></pre><h5 class="cm-react-header"><span class="cm-react-text">Finished </span><span class="cm-react-text">"</span><span class="cm-react-text">textarea</span><span class="cm-react-text">"</span><span class="cm-react-text"> with highlighted at-mentions</span></h5><div class="cm-react-html"><iframe src="example6.html" style="height:54px" sandbox="allow-scripts">
</iframe>
<div style="float:right">
<a href="example6.html" target="_blank">example6.html</a>
( <a href="/static/source_viewer_dyn.html#/blog/2015-12-22_rich_input/example6.html" target="_blank">full source</a> )
</div>
<div style="clear:both"></div></div><h4 class="cm-react-header"><span class="cm-react-text">Caveats and Gotchas</span></h4><ul class="cm-react-list"><li class="cm-react-li"><p class="cm-react-p"><span class="cm-react-text">instead of </span><a class="cm-react-link" href="https://w3c.github.io/editing/contentEditableTrue.html" title="" target="_blank"><code class="cm-react-code hljs ini"><span class="hljs-setting"><span class="hljs-setting">contenteditable=</span><span class="hljs-value"><span class="hljs-string"><span class="hljs-setting"><span class="hljs-value"><span class="hljs-string">"true"</span></span></span></span></span></span></code></a><span class="cm-react-text">, </span><a class="cm-react-link" href="http://w3c.github.io/editing/contentEditable.html#caret-state" title="" target="_blank"><code class="cm-react-code hljs ini"><span class="hljs-setting"><span class="hljs-setting">contenteditable=</span><span class="hljs-value"><span class="hljs-setting"><span class="hljs-value">typing</span></span></span></span></code></a><span class="cm-react-text"> may be the right choice, but I haven</span><span class="cm-react-text">'</span><span class="cm-react-text">t played with it enough.</span></p></li><li class="cm-react-li"><p class="cm-react-p"><span class="cm-react-text">undo is broken in these examples. There is a thing called </span><a class="cm-react-link" href="http://www.w3.org/TR/2008/WD-html5-20080610/editing.html#undomanager" title="" target="_blank"><span class="cm-react-text">UndoManager</span></a><span class="cm-react-text"> that can help. It would need its own post. I</span><span class="cm-react-text">'</span><span class="cm-react-text">m ignoring it for this example.</span></p></li><li class="cm-react-li"><p class="cm-react-p"><span class="cm-react-text">Things like what happens when you hit enter (newline? </span><code class="cm-react-code hljs apache"><span class="hljs-tag"><span class="hljs-tag">&lt;br&gt;</span></span></code><span class="cm-react-text">? </span><code class="cm-react-code hljs apache"><span class="hljs-tag"><span class="hljs-tag">&lt;p&gt;</span></span></code><span class="cm-react-text">?) are TOTALLY DIFFERENT in different browsers. I don</span><span class="cm-react-text">'</span><span class="cm-react-text">t handle line breaks correctly in these examples.</span></p></li><li class="cm-react-li"><p class="cm-react-p"><span class="cm-react-text">Every user agent has it</span><span class="cm-react-text">'</span><span class="cm-react-text">s own pile of legacy methods. The fiddle-till-it-works approach ends badly.</span></p></li><li class="cm-react-li"><p class="cm-react-p"><code class="cm-react-code hljs css"><span class="hljs-attr_selector"><span class="hljs-attr_selector">[selection]</span></span><span class="hljs-class"><span class="hljs-class">.anchorNode</span></span></code><span class="cm-react-text"> is a thing. </span><code class="cm-react-code hljs css"><span class="hljs-attr_selector"><span class="hljs-attr_selector">[selection]</span></span><span class="hljs-class"><span class="hljs-class">.baseNode</span></span></code><span class="cm-react-text"> is only a thing in some user agents.</span></p></li></ul><h2 class="cm-react-header"><a name="section-4" class="cm-section-id">4</a><span class="cm-react-text">next post: adding emoji / auto-complete</span></h2><p class="cm-react-p"><span class="cm-react-text">part 2 coming roughly </span><span class="cm-react-text">"</span><span class="cm-react-text">when I get around to writing it</span><span class="cm-react-text">"</span></p><div class="cm-react-html"><div id="disqus_thread"></div></div></div></div></div></div>
        </div>
    </div>
    <div id="footer-wrapper">Copyright (c) David Stein</div>
    </div>
</body>

</html>
